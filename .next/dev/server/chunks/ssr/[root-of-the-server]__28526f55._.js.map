{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 10, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/David%20Zapata/Desktop/viaticos/src/config/firebase.ts"],"sourcesContent":["// src/config/firebase.ts\r\nimport { initializeApp, getApps, FirebaseApp } from 'firebase/app'\r\nimport { getAuth, Auth } from 'firebase/auth'\r\n\r\nlet app: FirebaseApp | null = null\r\nlet auth: Auth | null = null\r\n\r\n/* ======================================================\r\n   FUNCI√ìN 1 ‚Äî OBTENER CONFIGURACI√ìN DE FIREBASE\r\n   ====================================================== */\r\nasync function getFirebaseConfig() {\r\n  // üöÄ SSR ‚Äî usar variables de entorno directamente\r\n  if (typeof window === 'undefined') {\r\n    return {\r\n      firebase: {\r\n        apiKey: process.env.NEXT_PUBLIC_FIREBASE_API_KEY ?? '',\r\n        authDomain: process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN ?? '',\r\n        projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID ?? '',\r\n      },\r\n      apiUrl:\r\n        process.env.NEXT_PUBLIC_CLOUDFLARE_API_URL ??\r\n        'https://viaticos.davidzapata-dz051099.workers.dev',\r\n    }\r\n  }\r\n\r\n  // üöÄ Cliente ‚Äî obtener desde /api/config\r\n  try {\r\n    const response = await fetch('/api/config')\r\n    if (!response.ok) throw new Error('Failed to fetch /api/config')\r\n    const json = await response.json()\r\n\r\n    // Validar\r\n    if (!json?.firebase?.apiKey) {\r\n      console.error('‚ùå /api/config: firebase.apiKey vac√≠o')\r\n    }\r\n\r\n    return json\r\n  } catch (err) {\r\n    console.error('‚ùå Error obteniendo configuraci√≥n:', err)\r\n    return {\r\n      firebase: {\r\n        apiKey: '',\r\n        authDomain: '',\r\n        projectId: '',\r\n      },\r\n      apiUrl: 'https://viaticos.davidzapata-dz051099.workers.dev',\r\n    }\r\n  }\r\n}\r\n\r\n/* ======================================================\r\n   FUNCI√ìN 2 ‚Äî INICIALIZAR FIREBASE\r\n   ====================================================== */\r\nexport async function initializeFirebase() {\r\n  if (typeof window === 'undefined') return null\r\n  if (app && auth) return { app, auth }\r\n\r\n  try {\r\n    const { firebase: firebaseConfig } = await getFirebaseConfig()\r\n\r\n    if (!firebaseConfig.apiKey) {\r\n      console.warn(\r\n        '‚ö† Firebase no est√° configurado. Revisa tus variables NEXT_PUBLIC_FIREBASE_*'\r\n      )\r\n      return null\r\n    }\r\n\r\n    if (getApps().length === 0) {\r\n      app = initializeApp(firebaseConfig)\r\n    } else {\r\n      app = getApps()[0]\r\n    }\r\n\r\n    auth = getAuth(app)\r\n    return { app, auth }\r\n  } catch (error) {\r\n    console.error('üî• Error inicializando Firebase:', error)\r\n  }\r\n}\r\n\r\nexport { auth }\r\nexport default app"],"names":[],"mappings":"AAAA,yBAAyB;;;;;;;;;AACzB;AACA;;;AAEA,IAAI,MAA0B;AAC9B,IAAI,OAAoB;AAExB;;0DAE0D,GAC1D,eAAe;IACb,kDAAkD;IAClD,wCAAmC;QACjC,OAAO;YACL,UAAU;gBACR,QAAQ,+EAA4C;gBACpD,YAAY,sEAAgD;gBAC5D,WAAW,sDAA+C;YAC5D;YACA,QACE,yFACA;QACJ;IACF;;;AAyBF;AAKO,eAAe;IACpB,wCAAmC,OAAO;;;AAwB5C;;uCAGe"}},
    {"offset": {"line": 53, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/David%20Zapata/Desktop/viaticos/src/services/api.ts"],"sourcesContent":["import { auth, initializeFirebase } from '../config/firebase'\r\n\r\n// Obtener API_URL desde el servidor o usar valor por defecto\r\nconst DEFAULT_API_URL = 'https://viaticos.davidzapata-dz051099.workers.dev'\r\n\r\nasync function getApiUrl(): Promise<string> {\r\n  // Simplificado para usar siempre la URL del worker de Cloudflare.\r\n  // La l√≥gica anterior fallaba porque la variable de entorno API_URL\r\n  // no est√° disponible en el entorno del servidor de Next.js.\r\n  return DEFAULT_API_URL\r\n}\r\n\r\nasync function getAuthToken() {\r\n  if (typeof window === 'undefined') {\r\n    throw new Error('getAuthToken solo puede ser llamado en el cliente')\r\n  }\r\n  \r\n  await initializeFirebase()\r\n  const { auth: currentAuth } = await import('../config/firebase')\r\n  \r\n  if (!currentAuth) {\r\n    throw new Error('Firebase Auth no est√° disponible. Verifica las variables de entorno NEXT_PUBLIC_FIREBASE_API_KEY, FIREBASE_AUTH_DOMAIN y FIREBASE_PROJECT_ID')\r\n  }\r\n  const user = currentAuth.currentUser\r\n  if (!user) {\r\n    throw new Error('Usuario no autenticado')\r\n  }\r\n  const token = await user.getIdToken()\r\n  return token\r\n}\r\n\r\nasync function apiRequest(endpoint: string, options: RequestInit = {}) {\r\n  try {\r\n    const token = await getAuthToken()\r\n    const API_URL = await getApiUrl()\r\n    \r\n    const response = await fetch(`${API_URL}${endpoint}`, {\r\n      ...options,\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'Authorization': `Bearer ${token}`,\r\n        ...options.headers,\r\n      },\r\n    })\r\n\r\n    // Leer la respuesta primero\r\n    const data = await response.json()\r\n    \r\n    // Si la respuesta no es OK, verificar si tiene success: true (puede ser lista vac√≠a)\r\n    if (!response.ok) {\r\n      // Si tiene success: true, retornarla (puede tener lista vac√≠a por error de BD)\r\n      if (data.success === true) {\r\n        return data\r\n      }\r\n      \r\n      // Mejorar mensajes de error\r\n      if (response.status === 401) {\r\n        throw new Error('Sesi√≥n expirada. Por favor, inicia sesi√≥n nuevamente.')\r\n      }\r\n      \r\n      throw new Error(data.message || data.error || 'Error en la solicitud')\r\n    }\r\n    \r\n    // Si hay un error en el body pero success es false, verificar si es error de BD\r\n    if (data.success === false && data.error) {\r\n      // Si el error es de BD (usuario, SQLITE, D1), retornar √©xito con lista vac√≠a\r\n      const errorMsg = data.error.toLowerCase()\r\n      if (errorMsg.includes('usuario') || errorMsg.includes('sqlite') || errorMsg.includes('d1_error')) {\r\n        console.warn('Error de BD detectado, retornando lista vac√≠a:', data.error)\r\n        return { success: true, viaticos: [] }\r\n      }\r\n      throw new Error(data.error || data.message || 'Error en la solicitud')\r\n    }\r\n\r\n    return data\r\n  } catch (error) {\r\n    // Si el error es de autenticaci√≥n, propagarlo con mensaje claro\r\n    if (error instanceof Error && error.message.includes('Usuario no autenticado')) {\r\n      throw new Error('Sesi√≥n expirada. Por favor, inicia sesi√≥n nuevamente.')\r\n    }\r\n    throw error\r\n  }\r\n}\r\n\r\nexport async function uploadViatico(viaticoData: FormData) {\r\n  const token = await getAuthToken()\r\n  const API_URL = await getApiUrl()\r\n\r\n  const response = await fetch(`${API_URL}/api/viaticos`, {\r\n    method: 'POST',\r\n    headers: {\r\n      'Authorization': `Bearer ${token}`,\r\n    },\r\n    body: viaticoData,\r\n  })\r\n\r\n  if (!response.ok) {\r\n    const error = await response.json().catch(() => ({ message: 'Error al subir vi√°tico' }))\r\n    throw new Error(error.message || 'Error al subir vi√°tico')\r\n  }\r\n\r\n  return response.json()\r\n}\r\n\r\nexport async function getTodaySummary() {\r\n  return apiRequest('/api/viaticos/today-summary', { method: 'GET' })\r\n}\r\n\r\nexport async function getMisViaticos() {\r\n  return apiRequest('/api/viaticos/mis-viaticos')\r\n}\r\n\r\nexport async function getAllViaticos() {\r\n  return apiRequest('/api/viaticos/all')\r\n}\r\n\r\nexport async function getViaticosByUser(userId: string) {\r\n  return apiRequest(`/api/viaticos/user/${userId}`)\r\n}\r\n\r\nexport async function getViaticosByDate(fecha: string) {\r\n  return apiRequest(`/api/viaticos/fecha/${fecha}`)\r\n}\r\n\r\nexport async function createUserFolder() {\r\n  return apiRequest('/api/users', { method: 'POST', body: JSON.stringify({}) })\r\n}\r\n\r\nexport async function getCurrentUser() {\r\n  return apiRequest('/api/users/me', { method: 'GET' })\r\n}\r\n\r\nexport async function getAllUsers() {\r\n  return apiRequest('/api/users', { method: 'GET' })\r\n}\r\n\r\nexport async function setUserRole(uid: string, role: string) {\r\n  return apiRequest(`/api/users/${uid}/role`, {\r\n    method: 'PUT',\r\n    body: JSON.stringify({ role }),\r\n  })\r\n}\r\n\r\nexport async function getOneDriveStructure() {\r\n  return apiRequest('/api/onedrive/structure', { method: 'GET' })\r\n}\r\n\r\nexport async function verifyOneDriveStructure() {\r\n  return apiRequest('/api/onedrive/verify-structure', { method: 'GET' })\r\n}\r\n\r\nexport async function ensureOneDriveFolders() {\r\n  return apiRequest('/api/onedrive/ensure', { method: 'POST' })\r\n}\r\n\r\nexport async function ensureOneDriveFolderForUser(uid: string) {\r\n  const token = await getAuthToken()\r\n  const API_URL = await getApiUrl()\r\n  const response = await fetch(`${API_URL}/api/onedrive/ensure-user/${uid}`, {\r\n    method: 'POST',\r\n    headers: { 'Authorization': `Bearer ${token}` },\r\n  })\r\n  if (!response.ok) {\r\n    const error = await response.json().catch(() => ({ message: 'Error asegurando carpeta' }))\r\n    throw new Error(error.message || 'Error asegurando carpeta')\r\n  }\r\n  return response.json()\r\n}\r\n\r\nexport async function ensureMyOneDriveFolder() {\r\n  const token = await getAuthToken()\r\n  const API_URL = await getApiUrl()\r\n  const response = await fetch(`${API_URL}/api/onedrive/ensure-me`, {\r\n    method: 'POST',\r\n    headers: { 'Authorization': `Bearer ${token}` },\r\n  })\r\n  if (!response.ok) {\r\n    const error = await response.json().catch(() => ({ message: 'Error asegurando carpeta' }))\r\n    throw new Error(error.message || 'Error asegurando carpeta')\r\n  }\r\n  return response.json()\r\n}\r\n\r\nexport async function ejecutarMigracion() {\r\n  const token = await getAuthToken()\r\n  const API_URL = await getApiUrl()\r\n  const response = await fetch(`${API_URL}/api/migrate`, {\r\n    method: 'POST',\r\n    headers: {\r\n      'Authorization': `Bearer ${token}`,\r\n      'Content-Type': 'application/json',\r\n    },\r\n  })\r\n\r\n  if (!response.ok) {\r\n    const error = await response.json().catch(() => ({ message: 'Error ejecutando migraci√≥n' }))\r\n    throw new Error(error.message || 'Error ejecutando migraci√≥n')\r\n  }\r\n\r\n  return response.json()\r\n}\r\n\r\nexport async function cleanupAnonymousUsers() {\r\n  const token = await getAuthToken()\r\n  const API_URL = await getApiUrl()\r\n  const response = await fetch(`${API_URL}/api/cleanup/anonymous`, {\r\n    method: 'POST',\r\n    headers: {\r\n      'Authorization': `Bearer ${token}`,\r\n      'Content-Type': 'application/json',\r\n    },\r\n  })\r\n\r\n  if (!response.ok) {\r\n    const error = await response.json().catch(() => ({ message: 'Error ejecutando limpieza' }))\r\n    throw new Error(error.message || 'Error ejecutando limpieza')\r\n  }\r\n\r\n  return response.json()\r\n}\r\n\r\nexport async function setUserStatus(uid: string, estado: 'activo' | 'inactivo') {\r\n  return apiRequest(`/api/users/${uid}/status`, {\r\n    method: 'PUT',\r\n    body: JSON.stringify({ estado }),\r\n  })\r\n}\r\n\r\nexport async function setUserCreateFolder(uid: string, crearCarpeta: boolean) {\r\n  return apiRequest(`/api/users/${uid}/create-folder`, {\r\n    method: 'PUT',\r\n    body: JSON.stringify({ crear_carpeta: crearCarpeta }),\r\n  })\r\n}\r\n\r\nexport async function deleteUser(uid: string) {\r\n  const token = await getAuthToken()\r\n  const API_URL = await getApiUrl()\r\n  const response = await fetch(`${API_URL}/api/users/${uid}`, {\r\n    method: 'DELETE',\r\n    headers: {\r\n      'Authorization': `Bearer ${token}`,\r\n      'Content-Type': 'application/json',\r\n    },\r\n  })\r\n\r\n  if (!response.ok) {\r\n    const error = await response.json().catch(() => ({ message: 'Error eliminando usuario' }))\r\n    throw new Error(error.message || 'Error eliminando usuario')\r\n  }\r\n\r\n  return response.json()\r\n}\r\n\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 351, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/David%20Zapata/Desktop/viaticos/src/contexts/AuthContext.tsx"],"sourcesContent":["'use client'\r\n\r\nimport { createContext, useContext, useState, useEffect } from 'react'\r\nimport { \r\n  signInWithEmailAndPassword, \r\n  createUserWithEmailAndPassword,\r\n  signOut as firebaseSignOut,\r\n  onAuthStateChanged,\r\n  OAuthProvider,\r\n  signInWithPopup,\r\n  signInWithRedirect,\r\n  getRedirectResult,  // Agregar esto\r\n  setPersistence,\r\n  browserLocalPersistence,\r\n  User,\r\n} from 'firebase/auth'\r\nimport { auth, initializeFirebase } from '../config/firebase'\r\nimport { createUserFolder } from '../services/api'\r\n\r\ninterface AuthContextType {\r\n  user: User | null\r\n  signIn: (email: string, password: string) => Promise<{ success: boolean; user?: User; error?: string }>\r\n  signUp: (email: string, password: string) => Promise<{ success: boolean; user?: User; error?: string }>\r\n  signInWithMicrosoft: () => Promise<{ success: boolean; user?: User; error?: string }>\r\n  signOut: () => Promise<{ success: boolean; error?: string }>\r\n  loading: boolean\r\n}\r\n\r\nconst AuthContext = createContext<AuthContextType>({\r\n  user: null,\r\n  signIn: async () => ({ success: false }),\r\n  signUp: async () => ({ success: false }),\r\n  signInWithMicrosoft: async () => ({ success: false }),\r\n  signOut: async () => ({ success: false }),\r\n  loading: true,\r\n})\r\n\r\nexport function useAuth() {\r\n  return useContext(AuthContext)\r\n}\r\n\r\nexport function AuthProvider({ children }: { children: React.ReactNode }) {\r\n  const [user, setUser] = useState<User | null>(null)\r\n  const [loading, setLoading] = useState(true)\r\n\r\n  useEffect(() => {\r\n    let unsub = () => {}\r\n\r\n    const setupAuth = async () => {\r\n      // Asegurar que Firebase est√© inicializado\r\n      await initializeFirebase()\r\n\r\n      // Re-importar auth para obtener la instancia actualizada\r\n      const { auth: currentAuth } = await import('../config/firebase')\r\n\r\n      if (!currentAuth) {\r\n        setLoading(false)\r\n        return\r\n      }\r\n\r\n      try {\r\n        // Usar browserLocalPersistence para que la sesi√≥n persista incluso despu√©s de cerrar el navegador\r\n        await setPersistence(currentAuth, browserLocalPersistence)\r\n      } catch (e) {\r\n        console.warn('No se pudo establecer persistencia local:', (e as Error).message || e)\r\n      }\r\n\r\n      // Verificar si hay un resultado de redirect pendiente\r\n      try {\r\n        const redirectResult = await getRedirectResult(currentAuth)\r\n        if (redirectResult) {\r\n          // Usuario regres√≥ de redirect, registrar en D1\r\n          try {\r\n            await createUserFolder()\r\n          } catch (e) {\r\n            console.warn('Nota: Las carpetas se crear√°n autom√°ticamente al subir el primer archivo')\r\n          }\r\n        }\r\n      } catch (e) {\r\n        // Ignorar errores de redirect\r\n      }\r\n\r\n      unsub = onAuthStateChanged(currentAuth, async (user) => {\r\n        setUser(user)\r\n        setLoading(false)\r\n        if (user) {\r\n          // Guardar token en cookie para el middleware\r\n          try {\r\n            const token = await user.getIdToken()\r\n            document.cookie = `firebase-token=${token}; path=/; max-age=604800; SameSite=Lax; Secure`\r\n            \r\n            // Renovar token autom√°ticamente cada hora\r\n            setInterval(async () => {\r\n              try {\r\n                const currentUser = currentAuth.currentUser\r\n                if (currentUser) {\r\n                  const newToken = await currentUser.getIdToken(true)\r\n                  document.cookie = `firebase-token=${newToken}; path=/; max-age=604800; SameSite=Lax; Secure`\r\n                }\r\n              } catch (e) {\r\n                console.warn('Error renovando token:', (e as Error).message || e)\r\n              }\r\n            }, 3600000)\r\n          } catch (e) {\r\n            console.warn('Error guardando token en cookie:', (e as Error).message || e)\r\n          }\r\n          \r\n          // CORREGIDO: Registrar usuario en la base de datos con email y displayName\r\n          try {\r\n            const { createUserFolder } = await import('@/services/api')\r\n            await createUserFolder().catch((e) => {\r\n              // Ignorar errores - el usuario se registrar√° en la pr√≥xima petici√≥n\r\n              console.warn('Nota: El usuario se registrar√° autom√°ticamente en la pr√≥xima acci√≥n')\r\n            })\r\n          } catch (e) {\r\n            // Ignorar errores\r\n          }\r\n        } else {\r\n          // Eliminar cookie al cerrar sesi√≥n\r\n          document.cookie = 'firebase-token=; path=/; max-age=0'\r\n        }\r\n      })\r\n    }\r\n\r\n    setupAuth()\r\n\r\n    return () => {\r\n      try { unsub() } catch (e) {}\r\n    }\r\n  }, [])\r\n\r\n  async function signIn(email: string, password: string) {\r\n    await initializeFirebase()\r\n    const { auth: currentAuth } = await import('../config/firebase')\r\n    if (!currentAuth) {\r\n      return { success: false, error: 'Firebase Auth no est√° disponible' }\r\n    }\r\n    try {\r\n      const userCredential = await signInWithEmailAndPassword(currentAuth, email, password)\r\n      return { success: true, user: userCredential.user }\r\n    } catch (error) {\r\n      return { success: false, error: (error as Error).message }\r\n    }\r\n  }\r\n\r\n  async function signInWithMicrosoft() {\r\n    await initializeFirebase()\r\n    const { auth: currentAuth } = await import('../config/firebase')\r\n    if (!currentAuth) {\r\n      return { success: false, error: 'Firebase Auth no est√° disponible. Verifica las variables de entorno.' }\r\n    }\r\n    try {\r\n      const provider = new OAuthProvider('microsoft.com')\r\n      // Solo pedir permisos b√°sicos de autenticaci√≥n - NO pedir acceso a OneDrive\r\n      // El acceso a OneDrive se maneja en el worker con su propio token\r\n      provider.addScope('openid')\r\n      provider.addScope('profile')\r\n      provider.addScope('email')\r\n      provider.addScope('offline_access')\r\n      // ELIMINAR: provider.addScope('Files.ReadWrite.All') - Esto requiere consentimiento del admin\r\n      \r\n      // Usar signInWithPopup (funciona correctamente, los warnings de COOP no afectan funcionalidad)\r\n      const result = await signInWithPopup(currentAuth, provider)\r\n      \r\n      // Registrar usuario en D1 (las carpetas se crear√°n autom√°ticamente al subir archivos)\r\n      try {\r\n        await createUserFolder()\r\n      } catch (e) {\r\n        // Ignorar errores - las carpetas se crear√°n autom√°ticamente\r\n        console.warn('Nota: Las carpetas se crear√°n autom√°ticamente al subir el primer archivo')\r\n      }\r\n      \r\n      return { success: true, user: result.user }\r\n    } catch (error: any) {\r\n      console.error('Error en signInWithMicrosoft:', error)\r\n      return { success: false, error: error.message || 'Error al iniciar sesi√≥n con Microsoft' }\r\n    }\r\n  }\r\n\r\n  async function signUp(email: string, password: string) {\r\n    await initializeFirebase()\r\n    const { auth: currentAuth } = await import('../config/firebase')\r\n    if (!currentAuth) {\r\n      return { success: false, error: 'Firebase Auth no est√° disponible' }\r\n    }\r\n    try {\r\n      const userCredential = await createUserWithEmailAndPassword(currentAuth, email, password)\r\n      try {\r\n        await createUserFolder()\r\n      } catch (e) {\r\n        console.warn('No se pudo crear la carpeta en OneDrive al registrar usuario:', (e as Error).message || e)\r\n      }\r\n      return { success: true, user: userCredential.user }\r\n    } catch (error) {\r\n      return { success: false, error: (error as Error).message }\r\n    }\r\n  }\r\n\r\n  async function signOut() {\r\n    await initializeFirebase()\r\n    const { auth: currentAuth } = await import('../config/firebase')\r\n    if (!currentAuth) {\r\n      return { success: false, error: 'Firebase Auth no est√° disponible' }\r\n    }\r\n    try {\r\n      await firebaseSignOut(currentAuth)\r\n      // Eliminar cookie al cerrar sesi√≥n\r\n      document.cookie = 'firebase-token=; path=/; max-age=0'\r\n      return { success: true }\r\n    } catch (error) {\r\n      return { success: false, error: (error as Error).message }\r\n    }\r\n  }\r\n\r\n  const value = {\r\n    user,\r\n    signIn,\r\n    signUp,\r\n    signInWithMicrosoft,\r\n    signOut,\r\n    loading\r\n  }\r\n\r\n  return (\r\n    <AuthContext.Provider value={value}>\r\n      {children}\r\n    </AuthContext.Provider>\r\n  )\r\n}\r\n\r\n"],"names":[],"mappings":"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"}}]
}