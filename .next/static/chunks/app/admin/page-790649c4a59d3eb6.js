(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[698],{67665:(e,s,a)=>{"use strict";a.r(s),a.d(s,{default:()=>ea});var i=a(95155),t=a(37042),r=a.n(t),n=a(27608),l=a(12115),o=a(32985),c=a(60668),d=a(81477),m=a(89239),u=a(45160),x=a(69613),h=a(29991),p=a(15283),j=a(50656),f=a(40980);let N=j.bL,g=l.forwardRef(({className:e,...s},a)=>(0,i.jsx)(j.B8,{ref:a,className:(0,f.cn)("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",e),...s}));g.displayName=j.B8.displayName;let v=l.forwardRef(({className:e,...s},a)=>(0,i.jsx)(j.l9,{ref:a,className:(0,f.cn)("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",e),...s}));v.displayName=j.l9.displayName;let A=l.forwardRef(({className:e,...s},a)=>(0,i.jsx)(j.UC,{ref:a,className:(0,f.cn)("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",e),...s}));A.displayName=j.UC.displayName;var y=a(31069),b=a(439),w=a(32390),C=a(76498),_=a(7810),E=a(91958),S=a(61767),T=a(12651),R=a(13175),O=a(6296),M=a(68459),B=a(37037),D=a(73321);function F({children:e,allowedRoles:s=["admin","super_admin"],redirectTo:a="/dashboard"}){let{user:t,loading:r}=(0,o.A)(),n=(0,D.useRouter)(),[d,m]=(0,l.useState)(null),[u,x]=(0,l.useState)(!0);async function h(){try{let e=await (0,c.getCurrentUser)(),i=e?.user?.role;if(m(i),!s.includes(i))return void n.push(a)}catch(e){n.push(a)}finally{x(!1)}}return((0,l.useEffect)(()=>{if(!r){if(!t)return void n.push("/login");h()}},[t,r,n]),r||u)?(0,i.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,i.jsx)(O.A,{className:"h-8 w-8 animate-spin"})}):t&&d&&s.includes(d)?(0,i.jsx)(i.Fragment,{children:e}):null}var P=a(22939),I=a(27412),U=a(3700),k=a(11215),$=a(59245),z=a(42869),L=a(38194),H=a(47339),V=a(48368),q=a(21362),Z=a(80723),J=a(49387),W=a(61878),Q=a(33210),G=a(46269),X=a(18831);a(13280);var Y=a(90029),K=a(60529);function ee({viaticos:e,users:s,onDelete:a,onUpdate:t}){let[r,n]=(0,l.useState)(null),[o,c]=(0,l.useState)(),[h,p]=(0,l.useState)(),[j,f]=(0,l.useState)(""),[y,b]=(0,l.useState)(null),[w,C]=(0,l.useState)(!1),_=e=>{let a=s.find(s=>s.uid===e);return a?a.displayName||a.email:e},E=(0,l.useMemo)(()=>{let s={};return e.forEach(e=>{s[e.usuario_id]||(s[e.usuario_id]={userName:_(e.usuario_id),total:0,count:0,viaticos:[]});let a="string"==typeof e.monto?parseFloat(e.monto):e.monto;s[e.usuario_id].total+=isNaN(a)?0:a,s[e.usuario_id].count+=1,s[e.usuario_id].viaticos.push(e)}),Object.entries(s).map(([e,s])=>({userId:e,...s})).sort((e,s)=>s.total-e.total)},[e,s]),S=(0,l.useMemo)(()=>e.filter(e=>{let s=(0,I.A)(e.fecha);if(o&&s<(0,U.A)(o)||h&&s>(0,k.A)(h))return!1;if(j.trim()){let s=j.toLowerCase();if(![e.fecha,e.para||"",e.tipo_comprobante||"",e.numero_documento||"",e.numero_comprobante||"",e.descripcion||"",_(e.usuario_id)].join(" ").toLowerCase().includes(s))return!1}return!0}).sort((e,s)=>new Date(s.fecha).getTime()-new Date(e.fecha).getTime()),[e,o,h,j,s]),T=(0,l.useMemo)(()=>r?E.find(e=>e.userId===r):null,[r,E]),R=async(e,s)=>{let a=new G.Workbook,i=a.addWorksheet("Reporte");e.length>0&&(i.columns=Object.keys(e[0]).map(e=>({header:e,key:e,width:20}))),i.addRows(e);let t=new Blob([await a.xlsx.writeBuffer()],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),r=window.URL.createObjectURL(t),n=document.createElement("a");n.href=r,n.download=`${s}_${(0,$.A)(new Date,"yyyyMMdd_HHmm")}.xlsx`,n.click(),window.URL.revokeObjectURL(r)},O=(e,s,a)=>{let i=new X.Ay;i.text(a,14,15),i.setFontSize(10),i.text(`Generado: ${(0,$.A)(new Date,"dd/MM/yyyy HH:mm")}`,14,22),i.autoTable({head:[e],body:s,startY:30}),i.save(`${a.replace(/ /g,"_")}_${(0,$.A)(new Date,"yyyyMMdd_HHmm")}.pdf`)},B=e=>{b(e),C(!0)};return(0,i.jsxs)("div",{className:"space-y-4",children:[(0,i.jsxs)(N,{defaultValue:"usuarios",className:"w-full",children:[(0,i.jsxs)(g,{className:"grid w-full max-w-md grid-cols-2",children:[(0,i.jsxs)(v,{value:"usuarios",children:[(0,i.jsx)(z.A,{className:"mr-2 h-4 w-4"}),"Por Usuarios"]}),(0,i.jsxs)(v,{value:"registros",children:[(0,i.jsx)(L.A,{className:"mr-2 h-4 w-4"}),"Por Registro"]})]}),(0,i.jsx)(A,{value:"usuarios",className:"mt-4",children:r?(0,i.jsxs)(d.Zp,{children:[(0,i.jsx)(d.aR,{children:(0,i.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[(0,i.jsxs)("div",{children:[(0,i.jsxs)(d.ZB,{children:["Detalle de ",T?.userName]}),(0,i.jsxs)(d.BT,{children:["Total: S/ ",T?.total.toLocaleString("es-PE",{minimumFractionDigits:2,maximumFractionDigits:2})]})]}),(0,i.jsxs)("div",{className:"flex gap-2",children:[(0,i.jsxs)(m.$,{variant:"outline",size:"sm",onClick:()=>n(null),children:[(0,i.jsx)(Z.A,{className:"h-4 w-4 sm:mr-2"}),(0,i.jsx)("span",{className:"hidden sm:inline",children:"Volver"})]}),(0,i.jsxs)(m.$,{variant:"outline",size:"sm",onClick:()=>{R(T.viaticos.map(e=>{let s=(0,I.A)(e.fecha);return{DIA:(0,$.A)(s,"d"),MES:(0,$.A)(s,"M"),A√ëO:(0,$.A)(s,"yyyy"),FECHA:(0,$.A)(s,"dd/MM/yyyy"),PARA:e.para||"","QUE SUSTENTA":e.que_sustenta||"VIATICO",TRABAJADOR:T.userName,"TIPO COMPROBANTE":e.tipo_comprobante||"",RUC:e.numero_documento||"","N\xb0 COMPROBANTE":e.numero_comprobante||"",MONTO:"string"==typeof e.monto?parseFloat(e.monto):e.monto,DESCRIPCION:e.descripcion}}),`Detalle_${T.userName}`)},children:[(0,i.jsx)(H.A,{className:"h-4 w-4 sm:mr-2 text-green-600"}),(0,i.jsx)("span",{className:"hidden sm:inline",children:"Excel"})]}),(0,i.jsxs)(m.$,{variant:"outline",size:"sm",onClick:()=>{O(["Dia","Mes","A\xf1o","Fecha","Para","Que Sustenta","Trabajador","Tipo Comprobante","N\xb0 Documento","N\xb0 Comprobante","Monto","Descripci\xf3n"],T.viaticos.map(e=>{let s=(0,I.A)(e.fecha);return[(0,$.A)(s,"d"),(0,$.A)(s,"M"),(0,$.A)(s,"yyyy"),(0,$.A)(s,"dd/MM/yyyy"),e.para||"",e.que_sustenta||"VIATICO",T.userName,e.tipo_comprobante||"",e.numero_documento||"",e.numero_comprobante||"",`S/ ${Number(e.monto).toFixed(2)}`,e.descripcion||"-"]}),`Detalle ${T.userName}`)},children:[(0,i.jsx)(V.A,{className:"h-4 w-4 sm:mr-2 text-red-600"}),(0,i.jsx)("span",{className:"hidden sm:inline",children:"PDF"})]})]})]})}),(0,i.jsx)(d.Wu,{children:(0,i.jsx)("div",{className:"rounded-md border overflow-x-auto",children:(0,i.jsxs)(x.XI,{children:[(0,i.jsx)(x.A0,{children:(0,i.jsxs)(x.Hj,{children:[(0,i.jsx)(x.nd,{children:"D\xeda"}),(0,i.jsx)(x.nd,{children:"Mes"}),(0,i.jsx)(x.nd,{children:"A\xf1o"}),(0,i.jsx)(x.nd,{children:"Fecha"}),(0,i.jsx)(x.nd,{children:"Para"}),(0,i.jsx)(x.nd,{children:"Que Sustenta"}),(0,i.jsx)(x.nd,{children:"Trabajador"}),(0,i.jsx)(x.nd,{children:"Tipo Comp."}),(0,i.jsx)(x.nd,{children:"N\xb0 Doc."}),(0,i.jsx)(x.nd,{children:"N\xb0 Comp."}),(0,i.jsx)(x.nd,{className:"text-right",children:"Monto"}),(0,i.jsx)(x.nd,{className:"hidden md:table-cell",children:"Descripci\xf3n"}),(0,i.jsx)(x.nd,{className:"text-right",children:"Acciones"})]})}),(0,i.jsx)(x.BF,{children:T?.viaticos.map(e=>(0,i.jsxs)(x.Hj,{children:[(0,i.jsx)(x.nA,{children:(0,$.A)((0,I.A)(e.fecha),"d")}),(0,i.jsx)(x.nA,{children:(0,$.A)((0,I.A)(e.fecha),"M")}),(0,i.jsx)(x.nA,{children:(0,$.A)((0,I.A)(e.fecha),"yyyy")}),(0,i.jsx)(x.nA,{className:"whitespace-nowrap",children:(0,$.A)((0,I.A)(e.fecha),"dd/MM/yyyy")}),(0,i.jsx)(x.nA,{children:(0,i.jsx)(u.E,{variant:"outline",className:"whitespace-nowrap",children:e.para||"-"})}),(0,i.jsx)(x.nA,{className:"whitespace-nowrap",children:e.que_sustenta||"VIATICO"}),(0,i.jsx)(x.nA,{className:"font-medium",children:T.userName}),(0,i.jsx)(x.nA,{children:(0,i.jsx)(u.E,{variant:"secondary",className:"whitespace-nowrap",children:e.tipo_comprobante||"-"})}),(0,i.jsx)(x.nA,{className:"whitespace-nowrap",children:e.numero_documento||"-"}),(0,i.jsx)(x.nA,{className:"whitespace-nowrap",children:e.numero_comprobante||"-"}),(0,i.jsxs)(x.nA,{className:"text-right whitespace-nowrap",children:["S/ ",Number(e.monto).toLocaleString("es-PE",{minimumFractionDigits:2,maximumFractionDigits:2})]}),(0,i.jsx)(x.nA,{className:"hidden md:table-cell max-w-xs truncate",children:e.descripcion||"-"}),(0,i.jsx)(x.nA,{className:"text-right",children:(0,i.jsxs)("div",{className:"flex justify-end gap-2",children:[(0,i.jsx)(m.$,{variant:"ghost",size:"sm",className:"text-blue-500 hover:text-blue-700 hover:bg-blue-50",onClick:s=>{s.stopPropagation(),B(e)},children:(0,i.jsx)(J.A,{className:"h-4 w-4"})}),(0,i.jsx)(m.$,{variant:"ghost",size:"sm",className:"text-red-500 hover:text-red-700 hover:bg-red-50",onClick:s=>{s.stopPropagation(),a(e.id)},children:(0,i.jsx)(M.A,{className:"h-4 w-4"})})]})})]},e.id))})]})})})]}):(0,i.jsxs)(d.Zp,{children:[(0,i.jsx)(d.aR,{children:(0,i.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[(0,i.jsxs)("div",{children:[(0,i.jsx)(d.ZB,{children:"Totales por Usuario"}),(0,i.jsx)(d.BT,{children:"Haz clic en un usuario para ver su detalle"})]}),(0,i.jsxs)("div",{className:"flex gap-2",children:[(0,i.jsxs)(m.$,{variant:"outline",size:"sm",onClick:()=>{R(E.map(e=>({Usuario:e.userName,"Cantidad Vi\xe1ticos":e.count,"Total (S/)":e.total})),"Reporte_Por_Usuarios")},children:[(0,i.jsx)(H.A,{className:"h-4 w-4 sm:mr-2 text-green-600"}),(0,i.jsx)("span",{className:"hidden sm:inline",children:"Excel"})]}),(0,i.jsxs)(m.$,{variant:"outline",size:"sm",onClick:()=>{O(["Usuario","Cant.","Total"],E.map(e=>[e.userName,e.count,`S/ ${e.total.toFixed(2)}`]),"Reporte Por Usuarios")},children:[(0,i.jsx)(V.A,{className:"h-4 w-4 sm:mr-2 text-red-600"}),(0,i.jsx)("span",{className:"hidden sm:inline",children:"PDF"})]})]})]})}),(0,i.jsx)(d.Wu,{children:(0,i.jsx)("div",{className:"rounded-md border overflow-x-auto",children:(0,i.jsxs)(x.XI,{children:[(0,i.jsx)(x.A0,{children:(0,i.jsxs)(x.Hj,{children:[(0,i.jsx)(x.nd,{children:"Usuario"}),(0,i.jsx)(x.nd,{className:"text-right",children:"Cantidad"}),(0,i.jsx)(x.nd,{className:"text-right",children:"Total"}),(0,i.jsx)(x.nd,{className:"text-right w-16"})]})}),(0,i.jsx)(x.BF,{children:0===E.length?(0,i.jsx)(x.Hj,{children:(0,i.jsx)(x.nA,{colSpan:4,className:"text-center py-8 text-muted-foreground",children:"No hay datos para mostrar"})}):E.map(e=>(0,i.jsxs)(x.Hj,{className:"cursor-pointer hover:bg-muted/50",onClick:()=>n(e.userId),children:[(0,i.jsx)(x.nA,{className:"font-medium",children:e.userName}),(0,i.jsx)(x.nA,{className:"text-right",children:e.count}),(0,i.jsxs)(x.nA,{className:"text-right font-bold",children:["S/ ",e.total.toLocaleString("es-PE",{minimumFractionDigits:2,maximumFractionDigits:2})]}),(0,i.jsx)(x.nA,{className:"text-right",children:(0,i.jsx)(q.A,{className:"h-4 w-4 inline text-muted-foreground"})})]},e.userId))})]})})})]})}),(0,i.jsxs)(A,{value:"registros",className:"mt-4 space-y-4",children:[(0,i.jsx)(d.Zp,{children:(0,i.jsx)(d.aR,{children:(0,i.jsxs)("div",{className:"flex flex-col gap-4",children:[(0,i.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[(0,i.jsxs)("div",{children:[(0,i.jsx)(d.ZB,{children:"Filtros"}),(0,i.jsx)(d.BT,{children:"Filtra los vi\xe1ticos por rango de fechas"})]}),(0,i.jsxs)("div",{className:"flex gap-2",children:[(0,i.jsxs)(m.$,{variant:"outline",size:"sm",onClick:()=>{let e=S.map(e=>{let s=(0,I.A)(e.fecha);return{DIA:(0,$.A)(s,"d"),MES:(0,$.A)(s,"M"),A√ëO:(0,$.A)(s,"yyyy"),FECHA:(0,$.A)(s,"dd/MM/yyyy"),PARA:e.para||"","QUE SUSTENTA":e.que_sustenta||"VIATICO",TRABAJADOR:_(e.usuario_id),"TIPO COMPROBANTE":e.tipo_comprobante||"",RUC:e.numero_documento||"","N\xb0 COMPROBANTE":e.numero_comprobante||"",MONTO:"string"==typeof e.monto?parseFloat(e.monto):e.monto,DESCRIPCION:e.descripcion}}),s="Reporte_Por_Registro";o&&h?s+=`_${(0,$.A)(o,"yyyyMMdd")}_al_${(0,$.A)(h,"yyyyMMdd")}`:o?s+=`_desde_${(0,$.A)(o,"yyyyMMdd")}`:h&&(s+=`_hasta_${(0,$.A)(h,"yyyyMMdd")}`),R(e,s)},children:[(0,i.jsx)(H.A,{className:"h-4 w-4 sm:mr-2 text-green-600"}),(0,i.jsx)("span",{className:"hidden sm:inline",children:"Excel"})]}),(0,i.jsxs)(m.$,{variant:"outline",size:"sm",onClick:()=>{O(["Dia","Mes","A\xf1o","Fecha","Para","Que Sustenta","Trabajador","Tipo Comprobante","N\xb0 Documento","N\xb0 Comprobante","Monto","Descripci\xf3n"],S.map(e=>{let s=(0,I.A)(e.fecha);return[(0,$.A)(s,"d"),(0,$.A)(s,"M"),(0,$.A)(s,"yyyy"),(0,$.A)(s,"dd/MM/yyyy"),e.para||"",e.que_sustenta||"VIATICO",_(e.usuario_id),e.tipo_comprobante||"",e.numero_documento||"",e.numero_comprobante||"",`S/ ${Number(e.monto).toFixed(2)}`,e.descripcion||"-"]}),"Reporte De viaticos")},children:[(0,i.jsx)(V.A,{className:"h-4 w-4 sm:mr-2 text-red-600"}),(0,i.jsx)("span",{className:"hidden sm:inline",children:"PDF"})]})]})]}),(0,i.jsxs)("div",{className:"space-y-4",children:[(0,i.jsxs)("div",{className:"relative",children:[(0,i.jsx)(W.A,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),(0,i.jsx)(K.p,{placeholder:"Buscar por fecha, usuario, descripci\xf3n, tipo comprobante...",value:j,onChange:e=>f(e.target.value),className:"pl-9 pr-9"}),j&&(0,i.jsx)(m.$,{variant:"ghost",size:"sm",className:"absolute right-1 top-1/2 transform -translate-y-1/2 h-7 w-7 p-0",onClick:()=>f(""),children:(0,i.jsx)(Q.A,{className:"h-4 w-4"})})]}),(0,i.jsxs)("div",{className:"grid gap-4 sm:grid-cols-2",children:[(0,i.jsxs)("div",{className:"space-y-2",children:[(0,i.jsx)("label",{className:"text-sm font-medium",children:"Desde"}),(0,i.jsx)(P.l,{date:o,onSelect:c,placeholder:"Selecciona fecha inicio"})]}),(0,i.jsxs)("div",{className:"space-y-2",children:[(0,i.jsx)("label",{className:"text-sm font-medium",children:"Hasta"}),(0,i.jsx)(P.l,{date:h,onSelect:p,placeholder:"Selecciona fecha fin",disabled:e=>!!o&&e<o})]})]})]})]})})}),(0,i.jsx)(d.Zp,{children:(0,i.jsx)(d.Wu,{className:"pt-6",children:(0,i.jsx)("div",{className:"rounded-md border overflow-x-auto",children:(0,i.jsxs)(x.XI,{children:[(0,i.jsx)(x.A0,{children:(0,i.jsxs)(x.Hj,{children:[(0,i.jsx)(x.nd,{children:"D\xeda"}),(0,i.jsx)(x.nd,{children:"Mes"}),(0,i.jsx)(x.nd,{children:"A\xf1o"}),(0,i.jsx)(x.nd,{children:"Fecha"}),(0,i.jsx)(x.nd,{children:"Para"}),(0,i.jsx)(x.nd,{children:"Que Sustenta"}),(0,i.jsx)(x.nd,{children:"Trabajador"}),(0,i.jsx)(x.nd,{children:"Tipo Comp."}),(0,i.jsx)(x.nd,{children:"N\xb0 Doc."}),(0,i.jsx)(x.nd,{children:"N\xb0 Comp."}),(0,i.jsx)(x.nd,{className:"text-right",children:"Monto"}),(0,i.jsx)(x.nd,{className:"hidden md:table-cell",children:"Descripci\xf3n"}),(0,i.jsx)(x.nd,{className:"text-right",children:"Acciones"})]})}),(0,i.jsx)(x.BF,{children:0===S.length?(0,i.jsx)(x.Hj,{children:(0,i.jsx)(x.nA,{colSpan:13,className:"text-center py-8 text-muted-foreground",children:"No hay datos para mostrar"})}):S.map(e=>(0,i.jsxs)(x.Hj,{children:[(0,i.jsx)(x.nA,{children:(0,$.A)((0,I.A)(e.fecha),"d")}),(0,i.jsx)(x.nA,{children:(0,$.A)((0,I.A)(e.fecha),"M")}),(0,i.jsx)(x.nA,{children:(0,$.A)((0,I.A)(e.fecha),"yyyy")}),(0,i.jsx)(x.nA,{className:"whitespace-nowrap",children:(0,$.A)((0,I.A)(e.fecha),"dd/MM/yyyy")}),(0,i.jsx)(x.nA,{children:(0,i.jsx)(u.E,{variant:"outline",className:"whitespace-nowrap",children:e.para||"-"})}),(0,i.jsx)(x.nA,{className:"whitespace-nowrap",children:e.que_sustenta||"VIATICO"}),(0,i.jsx)(x.nA,{className:"font-medium",children:_(e.usuario_id)}),(0,i.jsx)(x.nA,{children:(0,i.jsx)(u.E,{variant:"secondary",className:"whitespace-nowrap",children:e.tipo_comprobante||"-"})}),(0,i.jsx)(x.nA,{className:"whitespace-nowrap",children:e.numero_documento||"-"}),(0,i.jsx)(x.nA,{className:"whitespace-nowrap",children:e.numero_comprobante||"-"}),(0,i.jsxs)(x.nA,{className:"text-right whitespace-nowrap",children:["S/ ",Number(e.monto).toLocaleString("es-PE",{minimumFractionDigits:2,maximumFractionDigits:2})]}),(0,i.jsx)(x.nA,{className:"hidden md:table-cell max-w-xs truncate",children:e.descripcion||"-"}),(0,i.jsx)(x.nA,{className:"text-right",children:(0,i.jsxs)("div",{className:"flex justify-end gap-2",children:[(0,i.jsx)(m.$,{variant:"ghost",size:"sm",className:"text-blue-500 hover:text-blue-700 hover:bg-blue-50",onClick:()=>B(e),children:(0,i.jsx)(J.A,{className:"h-4 w-4"})}),(0,i.jsx)(m.$,{variant:"ghost",size:"sm",className:"text-red-500 hover:text-red-700 hover:bg-red-50",onClick:()=>a(e.id),children:(0,i.jsx)(M.A,{className:"h-4 w-4"})})]})})]},e.id))})]})})})})]})]}),(0,i.jsx)(Y._,{open:w,onOpenChange:C,viatico:y,onSuccess:()=>{t?.()}})]})}var es=a(71083);function ea(){let{user:e}=(0,o.A)(),{toast:s}=(0,n.dj)(),[a,t]=(0,l.useState)([]),[j,f]=(0,l.useState)([]),[D,P]=(0,l.useState)(null),[I,U]=(0,l.useState)(!0),[k,$]=(0,l.useState)(""),[z,L]=(0,l.useState)(null),{setLoading:H,clearLoading:V}=(0,es.M)(),[q,Z]=(0,l.useState)(null),J=e?.email?.toLowerCase()==="davidzapata_051099@hotmail.com".toLowerCase();async function W(){U(!0),$("");try{let[e,s,a]=await Promise.all([(0,c.getAllViaticos)(),(0,c.getAllUsers)(),(0,c.getCurrentUser)()]);P(a?.user?.role||null),t(e?.viaticos||[]);let i=s?.count!==void 0?s.count:(s?.users||[]).length,r=(s?.users||[]).filter(e=>(!!J||"super_admin"!==e.role)&&"anonymous"!==e.uid&&"dev-user"!==e.uid&&!e.uid.startsWith("dev-"));f(r),en(i)}catch(e){$("Error al cargar datos: "+e.message)}finally{U(!1)}}async function Q(e,a){H("Actualizando rol..."),L(e);try{await (0,c.setUserRole)(e,a),s({title:"Rol actualizado"}),await W()}catch(e){s({title:"Error",description:e.message||"Error al actualizar rol",variant:"destructive"})}finally{L(null),V()}}async function G(e,a){H("Actualizando estado...");try{await (0,c.setUserStatus)(e,a),s({title:"Estado actualizado"}),await W()}catch(e){s({title:"Error",description:"Error al actualizar estado",variant:"destructive"})}finally{V()}}async function X(e,s){if((await r().fire({title:"Eliminar usuario",html:`
        <div style="font-size:16px; text-align:left; line-height:1.6; padding: 5px 0;">
          <p>\xbfEst\xe1s seguro de que deseas eliminar al usuario <b>${s}</b>? Esto tambi\xe9n eliminar\xe1:</p>
          <ul style="margin-left:18px; padding-left:0;">
            <li>üóÇÔ∏è Su registro en la base de datos</li>
            <li>üìÑ Todos sus vi\xe1ticos</li>
            <li>‚òÅÔ∏è Su carpeta en OneDrive</li>
          </ul>
          <p style="margin-top:12px; color:#d9534f; font-weight:bold;">
            Esta acci\xf3n NO se puede deshacer.
          </p>
        </div>
      `,icon:"warning",iconColor:"#e63946",showCancelButton:!0,confirmButtonText:"Eliminar usuario",cancelButtonText:"Cancelar",confirmButtonColor:"#d62828",cancelButtonColor:"#6c757d",reverseButtons:!0,focusCancel:!0,width:500,customClass:{popup:"rounded-xl",confirmButton:"rounded-md px-4 py-2",cancelButton:"rounded-md px-4 py-2"}})).isConfirmed){H("Eliminando usuario y sus datos...");try{await (0,c.deleteUser)(e),V(),await r().fire({title:"Usuario eliminado",text:"El usuario fue eliminado correctamente.",icon:"success",confirmButtonColor:"#2a9d8f"}),await W()}catch(e){V(),await r().fire({title:"Error",text:"Error al eliminar usuario: "+e.message,icon:"error",confirmButtonColor:"#d62828"})}}}async function Y(){if((await r().fire({title:"\xbfLimpiar usuarios an\xf3nimos?",text:"Se eliminar\xe1n TODOS los usuarios anonymous y sus vi\xe1ticos. Esta acci\xf3n no se puede deshacer.",icon:"warning",showCancelButton:!0,confirmButtonText:"S\xed, limpiar",cancelButtonText:"Cancelar",confirmButtonColor:"#d33"})).isConfirmed)try{let e=await (0,c.cleanupAnonymousUsers)();r().fire("Completado",`Usuarios eliminados: ${e.deletedUsers}<br>Vi\xe1ticos eliminados: ${e.deletedViaticos}`,"success"),await W()}catch(e){r().fire("Error",e.message||"Error ejecutando limpieza","error")}}async function K(e){if((await r().fire({title:"\xbfEliminar vi\xe1tico?",text:"Esta acci\xf3n eliminar\xe1 el registro y los archivos asociados de OneDrive. No se puede deshacer.",icon:"warning",showCancelButton:!0,confirmButtonText:"S\xed, eliminar",cancelButtonText:"Cancelar",confirmButtonColor:"#d33"})).isConfirmed){H("Eliminando vi\xe1tico...");try{await (0,c.deleteViatico)(e),V(),await r().fire("Eliminado","El vi\xe1tico ha sido eliminado.","success"),await W()}catch(e){V(),await r().fire("Error",e.message||"Error al eliminar vi\xe1tico","error")}}}async function ea(){if((await r().fire({title:"Enviar Alerta de Cierre",text:"Se enviar\xe1 una notificaci\xf3n a TODOS los usuarios suscritos avisando que queda 1 hora.",icon:"question",showCancelButton:!0,confirmButtonText:"S\xed, enviar",cancelButtonText:"Cancelar"})).isConfirmed){H("Enviando notificaciones...");try{let s=await fetch("/api/push/broadcast",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${await e?.getIdToken()}`},body:JSON.stringify({title:"‚è≥ Cierre de Vi\xe1ticos en 1 hora",body:"Recuerda registrar tus vi\xe1ticos pendientes de ayer antes de las 10:00 AM.",url:"/nuevo-viatico"})}),a=await s.json();if(!s.ok)throw Error(a.error||"Error enviando");V(),r().fire("Enviado",`Notificaciones enviadas: ${a.sent}`,"success")}catch(e){V(),r().fire("Error",e.message,"error")}}}(0,l.useEffect)(()=>{e&&W()},[e]);let ei=a.length,et=a.reduce((e,s)=>{let a="string"==typeof s.monto?parseFloat(s.monto):s.monto;return e+(isNaN(a)?0:a)},0),[er,en]=(0,l.useState)(0);return(0,i.jsx)(F,{allowedRoles:["admin","super_admin"],children:(0,i.jsx)(B.A,{children:(0,i.jsxs)("div",{className:"space-y-8",children:[(0,i.jsxs)("div",{children:[(0,i.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:["super_admin"===D?(0,i.jsx)(y.A,{className:"h-6 w-6 text-yellow-500"}):(0,i.jsx)(b.A,{className:"h-6 w-6 text-blue-500"}),(0,i.jsx)("h1",{className:"text-3xl font-bold tracking-tight",children:"Panel de Administraci\xf3n"})]}),(0,i.jsx)("p",{className:"text-muted-foreground",children:"Gestiona todos los vi\xe1ticos y usuarios del sistema"})]}),k&&(0,i.jsx)(p.Fc,{variant:"destructive",children:(0,i.jsx)(p.TN,{children:k})}),(0,i.jsxs)("div",{className:"grid gap-4 md:grid-cols-3",children:[(0,i.jsxs)(d.Zp,{children:[(0,i.jsxs)(d.aR,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[(0,i.jsx)(d.ZB,{className:"text-sm font-medium",children:"Total Vi\xe1ticos"}),(0,i.jsx)(w.A,{className:"h-4 w-4 text-muted-foreground"})]}),(0,i.jsxs)(d.Wu,{children:[(0,i.jsx)("div",{className:"text-2xl font-bold",children:ei}),(0,i.jsx)("p",{className:"text-xs text-muted-foreground",children:"Registros en el sistema"})]})]}),(0,i.jsxs)(d.Zp,{children:[(0,i.jsxs)(d.aR,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[(0,i.jsx)(d.ZB,{className:"text-sm font-medium",children:"Total Monto"}),(0,i.jsx)(C.A,{className:"h-4 w-4 text-muted-foreground"})]}),(0,i.jsxs)(d.Wu,{children:[(0,i.jsxs)("div",{className:"text-2xl font-bold",children:["S/ ",et.toLocaleString("es-PE",{minimumFractionDigits:2,maximumFractionDigits:2})]}),(0,i.jsx)("p",{className:"text-xs text-muted-foreground",children:"Suma de todos los vi\xe1ticos"})]})]}),(0,i.jsxs)(d.Zp,{children:[(0,i.jsxs)(d.aR,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[(0,i.jsx)(d.ZB,{className:"text-sm font-medium",children:"Usuarios"}),(0,i.jsx)(_.A,{className:"h-4 w-4 text-muted-foreground"})]}),(0,i.jsxs)(d.Wu,{children:[(0,i.jsx)("div",{className:"text-2xl font-bold",children:er}),(0,i.jsx)("p",{className:"text-xs text-muted-foreground",children:"Usuarios registrados"})]})]})]}),(0,i.jsxs)(N,{defaultValue:"viaticos",className:"space-y-4",children:[(0,i.jsxs)("div",{className:"flex items-center justify-between",children:[(0,i.jsxs)(g,{children:[(0,i.jsx)(v,{value:"viaticos",children:"Vi\xe1ticos"}),(0,i.jsx)(v,{value:"usuarios",children:"Usuarios"})]}),(0,i.jsx)("div",{className:"flex items-center gap-2",children:(0,i.jsxs)(m.$,{onClick:W,variant:"outline",size:"sm",disabled:I,children:[(0,i.jsx)(E.A,{className:`h-4 w-4 mr-2 ${I?"animate-spin":""}`}),"Actualizar"]})})]}),(0,i.jsx)(A,{value:"viaticos",className:"space-y-4",children:(0,i.jsx)(ee,{viaticos:a,users:j,onDelete:K})}),(0,i.jsx)(A,{value:"usuarios",className:"space-y-4",children:(0,i.jsxs)(d.Zp,{children:[(0,i.jsxs)(d.aR,{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3",children:[(0,i.jsx)(d.ZB,{children:"Gesti\xf3n de Usuarios"}),(0,i.jsxs)("div",{className:"flex gap-2",children:[(0,i.jsxs)(m.$,{onClick:ea,variant:"outline",size:"sm",children:[(0,i.jsx)(S.A,{className:"h-4 w-4 mr-2"}),"Alerta 1h"]}),J&&(0,i.jsx)(m.$,{onClick:Y,variant:"destructive",size:"sm",children:"Limpiar Anonymous"})]})]}),(0,i.jsx)(d.Wu,{children:0===j.length?(0,i.jsx)("div",{className:"text-center py-8 text-muted-foreground",children:"No hay usuarios registrados"}):(0,i.jsx)("div",{className:"rounded-md border overflow-x-auto",children:(0,i.jsxs)(x.XI,{children:[(0,i.jsx)(x.A0,{children:(0,i.jsxs)(x.Hj,{children:[(0,i.jsx)(x.nd,{children:"Usuario"}),(0,i.jsx)(x.nd,{children:"Email"}),(0,i.jsx)(x.nd,{children:"Rol Actual"}),(0,i.jsx)(x.nd,{children:"Estado"}),(0,i.jsx)(x.nd,{children:"Cambiar Rol"}),(0,i.jsx)(x.nd,{className:"text-right",children:"Acciones"})]})}),(0,i.jsx)(x.BF,{children:j.map(s=>(0,i.jsxs)(x.Hj,{children:[(0,i.jsx)(x.nA,{children:s.displayName||s.email.split("@")[0]}),(0,i.jsx)(x.nA,{children:s.email}),(0,i.jsx)(x.nA,{children:(0,i.jsx)(u.E,{variant:"super_admin"===s.role?"default":"admin"===s.role?"secondary":"outline",children:"super_admin"===s.role?"Super Admin":"admin"===s.role?"Admin":"Usuario"})}),(0,i.jsx)(x.nA,{children:(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[(0,i.jsx)(u.E,{variant:"activo"===s.estado?"default":"destructive",children:"activo"===s.estado?(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(T.A,{className:"h-3 w-3 mr-1"}),"Activo"]}):(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(R.A,{className:"h-3 w-3 mr-1"}),"Inactivo"]})}),"super_admin"===D&&"super_admin"!==s.role&&(0,i.jsxs)(h.l6,{value:s.estado||"activo",onValueChange:e=>G(s.uid,e),children:[(0,i.jsx)(h.bq,{className:"w-32",children:(0,i.jsx)(h.yv,{})}),(0,i.jsxs)(h.gC,{children:[(0,i.jsx)(h.eb,{value:"activo",children:"Activo"}),(0,i.jsx)(h.eb,{value:"inactivo",children:"Inactivo"})]})]})]})}),(0,i.jsx)(x.nA,{children:(0,i.jsxs)(h.l6,{value:s.role,onValueChange:e=>Q(s.uid,e),disabled:s.uid===e?.uid||"super_admin"===s.role||"super_admin"!==D&&"super_admin"===s.role,children:[(0,i.jsx)(h.bq,{className:"w-40",children:z===s.uid?(0,i.jsx)(O.A,{className:"h-4 w-4 animate-spin"}):(0,i.jsx)(h.yv,{})}),(0,i.jsxs)(h.gC,{children:[(0,i.jsx)(h.eb,{value:"usuario",children:"Usuario"}),(0,i.jsx)(h.eb,{value:"admin",children:"Admin"}),"super_admin"===D&&(0,i.jsx)(h.eb,{value:"super_admin",children:"Super Admin"})]})]})}),(0,i.jsx)(x.nA,{className:"text-right",children:("super_admin"===D&&"super_admin"!==s.role||"admin"===D&&"super_admin"!==s.role)&&(0,i.jsx)(m.$,{variant:"destructive",size:"sm",onClick:()=>X(s.uid,s.email),children:(0,i.jsx)(M.A,{className:"h-4 w-4"})})})]},s.uid))})]})})})]})})]})]})})})}},69613:(e,s,a)=>{"use strict";a.d(s,{A0:()=>l,BF:()=>o,Hj:()=>c,XI:()=>n,nA:()=>m,nd:()=>d});var i=a(95155),t=a(12115),r=a(40980);let n=t.forwardRef(({className:e,...s},a)=>(0,i.jsx)("div",{className:"relative w-full overflow-auto",children:(0,i.jsx)("table",{ref:a,className:(0,r.cn)("w-full caption-bottom text-sm",e),...s})}));n.displayName="Table";let l=t.forwardRef(({className:e,...s},a)=>(0,i.jsx)("thead",{ref:a,className:(0,r.cn)("[&_tr]:border-b",e),...s}));l.displayName="TableHeader";let o=t.forwardRef(({className:e,...s},a)=>(0,i.jsx)("tbody",{ref:a,className:(0,r.cn)("[&_tr:last-child]:border-0",e),...s}));o.displayName="TableBody",t.forwardRef(({className:e,...s},a)=>(0,i.jsx)("tfoot",{ref:a,className:(0,r.cn)("border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",e),...s})).displayName="TableFooter";let c=t.forwardRef(({className:e,...s},a)=>(0,i.jsx)("tr",{ref:a,className:(0,r.cn)("border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",e),...s}));c.displayName="TableRow";let d=t.forwardRef(({className:e,...s},a)=>(0,i.jsx)("th",{ref:a,className:(0,r.cn)("h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",e),...s}));d.displayName="TableHead";let m=t.forwardRef(({className:e,...s},a)=>(0,i.jsx)("td",{ref:a,className:(0,r.cn)("p-4 align-middle [&:has([role=checkbox])]:pr-0",e),...s}));m.displayName="TableCell",t.forwardRef(({className:e,...s},a)=>(0,i.jsx)("caption",{ref:a,className:(0,r.cn)("mt-4 text-sm text-muted-foreground",e),...s})).displayName="TableCaption"},71083:(e,s,a)=>{"use strict";a.d(s,{LoadingProvider:()=>l,M:()=>o});var i=a(95155),t=a(12115),r=a(6296);let n=(0,t.createContext)(void 0);function l({children:e}){let[s,a]=(0,t.useState)(!1),[l,o]=(0,t.useState)("Cargando...");return(0,i.jsxs)(n.Provider,{value:{isLoading:s,loadingMessage:l,setLoading:(e="Cargando...")=>{o(e),a(!0)},clearLoading:()=>{a(!1)}},children:[e,s&&(0,i.jsx)("div",{className:"fixed inset-0 bg-background/80 backdrop-blur-sm z-50 flex items-center justify-center",children:(0,i.jsxs)("div",{className:"flex flex-col items-center gap-4",children:[(0,i.jsx)(r.A,{className:"h-12 w-12 animate-spin text-primary"}),(0,i.jsx)("p",{className:"text-lg font-medium text-foreground",children:l})]})})]})}function o(){let e=(0,t.useContext)(n);if(void 0===e)throw Error("useLoading must be used within a LoadingProvider");return e}},75694:(e,s,a)=>{Promise.resolve().then(a.bind(a,67665))},90029:(e,s,a)=>{"use strict";a.d(s,{_:()=>N});var i=a(95155),t=a(12115),r=a(59245),n=a(42763),l=a(89239),o=a(37042),c=a.n(o),d=a(60529),m=a(33807),u=a(18349),x=a(29991),h=a(60668),p=a(32985),j=a(71083),f=a(22939);function N({viatico:e,open:s,onOpenChange:a,onSuccess:o}){let{appUser:N}=(0,p.A)(),{setLoading:g,clearLoading:v}=(0,j.M)(),[A,y]=(0,t.useState)({});(0,t.useEffect)(()=>{e&&y({fecha:e.fecha,monto:e.monto,descripcion:e.descripcion,para:e.para||"",que_sustenta:e.que_sustenta||"VIATICO",tipo_comprobante:e.tipo_comprobante||"",numero_documento:e.numero_documento||"",numero_comprobante:e.numero_comprobante||""})},[e]);let b=(e,s)=>{y(a=>({...a,[e]:s}))},w=async s=>{if(s.preventDefault(),e){g("Actualizando vi\xe1tico...");try{await (0,h.updateViatico)(e.id,A),a(!1),o(),v(),await c().fire({title:"Actualizado",text:"El vi\xe1tico ha sido actualizado correctamente.",icon:"success",timer:1500,showConfirmButton:!1})}catch(e){v(),c().fire({title:"Error",text:e.message||"Error al actualizar vi\xe1tico",icon:"error",confirmButtonColor:"#ef4444"})}}};return e?(0,i.jsx)(n.lG,{open:s,onOpenChange:a,children:(0,i.jsxs)(n.Cf,{className:"sm:max-w-[425px]",children:[(0,i.jsxs)(n.c7,{children:[(0,i.jsx)(n.L3,{children:"Editar Vi\xe1tico"}),(0,i.jsx)(n.rr,{children:"Modifica los detalles del vi\xe1tico. Haz clic en guardar cuando termines."})]}),(0,i.jsxs)("form",{onSubmit:w,className:"grid gap-4 py-4",children:[(N?.role==="admin"||N?.role==="super_admin")&&(0,i.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-4 items-center gap-2 sm:gap-4",children:[(0,i.jsx)(m.J,{className:"text-left sm:text-right",children:"Fecha"}),(0,i.jsx)("div",{className:"col-span-1 sm:col-span-3",children:(0,i.jsx)(f.l,{date:A.fecha?new Date(A.fecha+"T12:00:00"):void 0,onSelect:e=>{e&&b("fecha",(0,r.A)(e,"yyyy-MM-dd"))}})})]}),(0,i.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-4 items-center gap-2 sm:gap-4",children:[(0,i.jsx)(m.J,{htmlFor:"monto",className:"text-left sm:text-right",children:"Monto"}),(0,i.jsx)(d.p,{id:"monto",type:"number",step:"0.01",value:A.monto,onChange:e=>b("monto",e.target.value),className:"col-span-1 sm:col-span-3",required:!0})]}),(0,i.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-4 items-center gap-2 sm:gap-4",children:[(0,i.jsx)(m.J,{htmlFor:"descripcion",className:"text-left sm:text-right",children:"Descripci\xf3n"}),(0,i.jsx)(u.T,{id:"descripcion",value:A.descripcion,onChange:e=>b("descripcion",e.target.value),className:"col-span-1 sm:col-span-3",required:!0})]}),(0,i.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-4 items-center gap-2 sm:gap-4",children:[(0,i.jsx)(m.J,{htmlFor:"para",className:"text-left sm:text-right",children:"Para"}),(0,i.jsxs)(x.l6,{value:A.para,onValueChange:e=>b("para",e),children:[(0,i.jsx)(x.bq,{className:"col-span-1 sm:col-span-3",children:(0,i.jsx)(x.yv,{placeholder:"Seleccionar"})}),(0,i.jsxs)(x.gC,{children:[(0,i.jsx)(x.eb,{value:"EMPRESA",children:"EMPRESA"}),(0,i.jsx)(x.eb,{value:"PERSONAL",children:"PERSONAL"})]})]})]}),(0,i.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-4 items-center gap-2 sm:gap-4",children:[(0,i.jsx)(m.J,{htmlFor:"tipo_comprobante",className:"text-left sm:text-right",children:"Tipo Comp."}),(0,i.jsxs)(x.l6,{value:A.tipo_comprobante,onValueChange:e=>b("tipo_comprobante",e),children:[(0,i.jsx)(x.bq,{className:"col-span-1 sm:col-span-3",children:(0,i.jsx)(x.yv,{placeholder:"Seleccionar"})}),(0,i.jsxs)(x.gC,{children:[(0,i.jsx)(x.eb,{value:"FACTURA",children:"FACTURA"}),(0,i.jsx)(x.eb,{value:"BOLETA",children:"BOLETA"}),(0,i.jsx)(x.eb,{value:"RECIBO POR HONORARIO",children:"RECIBO POR HONORARIO"}),(0,i.jsx)(x.eb,{value:"SIN COMPROBANTE",children:"SIN COMPROBANTE"})]})]})]}),A.tipo_comprobante&&"SIN COMPROBANTE"!==A.tipo_comprobante&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-4 items-center gap-2 sm:gap-4",children:[(0,i.jsx)(m.J,{htmlFor:"numero_documento",className:"text-left sm:text-right",children:"BOLETA"===A.tipo_comprobante?"N\xb0 DNI":"N\xb0 RUC"}),(0,i.jsx)(d.p,{id:"numero_documento",value:A.numero_documento,onChange:e=>b("numero_documento",e.target.value),className:"col-span-1 sm:col-span-3",placeholder:"BOLETA"===A.tipo_comprobante?"Ej: 12345678":"Ej: 20123456789"})]}),(0,i.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-4 items-center gap-2 sm:gap-4",children:[(0,i.jsx)(m.J,{htmlFor:"numero_comprobante",className:"text-left sm:text-right",children:"N\xb0 Comp."}),(0,i.jsx)(d.p,{id:"numero_comprobante",value:A.numero_comprobante,onChange:e=>b("numero_comprobante",e.target.value),className:"col-span-1 sm:col-span-3",placeholder:"Serie-N\xfamero"})]})]}),(0,i.jsx)(n.Es,{children:(0,i.jsx)(l.$,{type:"submit",children:"Guardar cambios"})})]})]})}):null}}},e=>{e.O(0,[159,320,33,930,343,633,443,435,887,423,531,985,225,649,441,511,358],()=>e(e.s=75694)),_N_E=e.O()}]);