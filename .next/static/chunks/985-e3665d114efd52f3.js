"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[985],{27608:(e,r,t)=>{t.d(r,{dj:()=>d,oR:()=>l});var a=t(12115);let s=0,o=new Map,i=e=>{if(o.has(e))return;let r=setTimeout(()=>{o.delete(e),u({type:"REMOVE_TOAST",toastId:e})},1e6);o.set(e,r)},n=[],c={toasts:[]};function u(e){c=((e,r)=>{switch(r.type){case"ADD_TOAST":return{...e,toasts:[r.toast,...e.toasts].slice(0,1)};case"UPDATE_TOAST":return{...e,toasts:e.toasts.map(e=>e.id===r.toast.id?{...e,...r.toast}:e)};case"DISMISS_TOAST":{let{toastId:t}=r;return t?i(t):e.toasts.forEach(e=>{i(e.id)}),{...e,toasts:e.toasts.map(e=>e.id===t||void 0===t?{...e,open:!1}:e)}}case"REMOVE_TOAST":if(void 0===r.toastId)return{...e,toasts:[]};return{...e,toasts:e.toasts.filter(e=>e.id!==r.toastId)}}})(c,e),n.forEach(e=>{e(c)})}function l(e){let r=(s=(s+1)%Number.MAX_VALUE).toString(),t=()=>u({type:"DISMISS_TOAST",toastId:r});return u({type:"ADD_TOAST",toast:{...e,id:r,open:!0,onOpenChange:e=>{e||t()}}}),{id:r,dismiss:t,update:e=>u({type:"UPDATE_TOAST",toast:{...e,id:r}})}}function d(){let[e,r]=a.useState(c);return a.useEffect(()=>(n.push(r),()=>{let e=n.indexOf(r);e>-1&&n.splice(e,1)}),[e]),{...e,toast:l,dismiss:e=>u({type:"DISMISS_TOAST",toastId:e})}}},32985:(e,r,t)=>{t.d(r,{A:()=>l,AuthProvider:()=>d});var a=t(95155),s=t(12115),o=t(96905),i=t(50007),n=t(60668),c=t(66877);let u=(0,s.createContext)({user:null,appUser:null,signIn:async()=>({success:!1}),signUp:async()=>({success:!1}),signInWithMicrosoft:async()=>({success:!1}),signOut:async()=>({success:!1}),loading:!0});function l(){return(0,s.useContext)(u)}function d({children:e}){let[r,l]=(0,s.useState)(null),[d,h]=(0,s.useState)(null),[p,f]=(0,s.useState)(!0),[m,w]=(0,s.useState)(!1);async function y(e,r){await (0,i.h)();let{auth:a}=await Promise.resolve().then(t.bind(t,50007));if(!a)return{success:!1,error:"Firebase Auth no est\xe1 disponible"};try{let t=await (0,o.x9)(a,e,r);return{success:!0,user:t.user}}catch(e){return{success:!1,error:e.message}}}async function g(){await (0,i.h)();let{auth:e}=await Promise.resolve().then(t.bind(t,50007));if(!e)return{success:!1,error:"Firebase Auth no est\xe1 disponible. Verifica las variables de entorno."};try{let r=new o.LD("microsoft.com");r.addScope("openid"),r.addScope("profile"),r.addScope("email"),r.addScope("offline_access");let a=await (0,o.df)(e,r),{getAdditionalUserInfo:s}=await Promise.resolve().then(t.bind(t,96905));if(s(a)?.isNewUser)try{w(!0);let{ensureMyOneDriveFolder:e}=await Promise.resolve().then(t.bind(t,60668));await e()}catch(e){console.warn("No se pudo crear la carpeta para el nuevo usuario:",e.message||e)}finally{w(!1)}return{success:!0,user:a.user}}catch(e){if("auth/popup-closed-by-user"===e.code)return console.log("Usuario cerr\xf3 el popup de autenticaci\xf3n"),{success:!1,error:"Inicio de sesi\xf3n cancelado por el usuario"};return console.error("Error en signInWithMicrosoft:",e),{success:!1,error:e.message||"Error al iniciar sesi\xf3n con Microsoft"}}}async function b(e,r){await (0,i.h)();let{auth:a}=await Promise.resolve().then(t.bind(t,50007));if(!a)return{success:!1,error:"Firebase Auth no est\xe1 disponible"};try{let t=await (0,o.eJ)(a,e,r);try{w(!0),await (0,n.ensureMyOneDriveFolder)()}catch(e){console.warn("No se pudo crear la carpeta en OneDrive al registrar usuario:",e.message||e)}finally{w(!1)}return{success:!0,user:t.user}}catch(e){return{success:!1,error:e.message}}}async function v(){await (0,i.h)();let{auth:e}=await Promise.resolve().then(t.bind(t,50007));if(!e)return{success:!1,error:"Firebase Auth no est\xe1 disponible"};try{try{await (0,c.Q)()}catch(e){console.warn("Error unsubscribing push:",e)}return await (0,o.CI)(e),document.cookie="firebase-token=; path=/; max-age=0",{success:!0}}catch(e){return{success:!1,error:e.message}}}return(0,s.useEffect)(()=>{let e=()=>{};return(async()=>{await (0,i.h)();let{auth:r}=await Promise.resolve().then(t.bind(t,50007));if(!r)return f(!1);try{await (0,o.oM)(r,o.F0)}catch(e){console.warn("No se pudo establecer persistencia local:",e.message||e)}try{let e=await (0,o.Q4)(r);if(e){let{getAdditionalUserInfo:r}=await Promise.resolve().then(t.bind(t,96905));if(r(e)?.isNewUser)try{w(!0);let{ensureMyOneDriveFolder:e}=await Promise.resolve().then(t.bind(t,60668));await e()}catch(e){console.warn("No se pudo crear la carpeta para el nuevo usuario:",e.message||e)}finally{w(!1)}}}catch(e){}e=(0,o.hg)(r,async e=>{l(e),e?(e.getIdToken().then(e=>(document.cookie=`firebase-token=${e}; path=/; max-age=604800; SameSite=Lax; Secure`,(0,n.getMyUser)())).then(async e=>{if(e&&e.exists){if("inactivo"===e.estado){await r.signOut(),l(null),h(null);let e=(await t.e(320).then(t.t.bind(t,37042,23))).default;await e.fire({title:"Cuenta Inactiva",text:"Tu cuenta ha sido desactivada por un administrador. Contacta a soporte para m\xe1s informaci\xf3n.",icon:"error",confirmButtonColor:"#ea580c"});return}h(e);try{let{subscribeToPush:e}=await Promise.resolve().then(t.bind(t,66877));await e(),console.log("Push notifications auto-subscribed")}catch(e){console.warn("Could not auto-subscribe to push notifications:",e)}}else{console.log("Usuario no encontrado en BD, registrando...");try{w(!0);let{ensureMyOneDriveFolder:e}=await Promise.resolve().then(t.bind(t,60668));await e();let r=await (0,n.getMyUser)();if(r){h(r);try{let{subscribeToPush:e}=await Promise.resolve().then(t.bind(t,66877));await e(),console.log("Push notifications auto-subscribed for new user")}catch(e){console.warn("Could not auto-subscribe to push notifications:",e)}}}catch(e){console.warn("Error auto-registrando usuario:",e)}finally{w(!1)}}}).catch(e=>{console.warn("Error fetching user data:",e),h(null)}),setInterval(async()=>{try{let e=r.currentUser;if(e){let r=await e.getIdToken(!0);document.cookie=`firebase-token=${r}; path=/; max-age=604800; SameSite=Lax; Secure`}}catch(e){console.warn("Error renovando token:",e.message||e)}},36e5)):(document.cookie="firebase-token=; path=/; max-age=0",h(null)),f(!1)})})(),()=>{try{e()}catch(e){}}},[]),(0,a.jsxs)(u.Provider,{value:{user:r,appUser:d,signIn:y,signUp:b,signInWithMicrosoft:g,signOut:v,loading:p},children:[e,m&&(0,a.jsx)("div",{className:"fixed inset-0 bg-background/80 backdrop-blur-sm z-[9999] flex items-center justify-center",children:(0,a.jsxs)("div",{className:"flex flex-col items-center gap-4 p-6 bg-card rounded-lg shadow-lg border",children:[(0,a.jsx)("div",{className:"h-12 w-12 animate-spin rounded-full border-4 border-primary border-t-transparent"}),(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("h3",{className:"text-lg font-semibold",children:"Verificando carpeta..."}),(0,a.jsx)("p",{className:"text-sm text-muted-foreground",children:"Configurando tu espacio en OneDrive"})]})]})})]})}},50007:(e,r,t)=>{t.d(r,{auth:()=>i,h:()=>c});var a=t(97873),s=t(96905);let o=null,i=null;async function n(){return{firebase:{apiKey:"AIzaSyDl0BvJnN3m2AVSZpCr6Dqbt3mIMa7ZITM",authDomain:"viaticos-d5652.firebaseapp.com",projectId:"viaticos-d5652"},apiUrl:"https://viaticos.davidzapata-dz051099.workers.dev"}}async function c(){if(o&&i)return{app:o,auth:i};try{let{firebase:e}=await n();if(!e.apiKey)return console.warn("âš  Firebase no est\xe1 configurado."),null;return o=0===(0,a.Dk)().length?(0,a.Wp)(e):(0,a.Dk)()[0],i=(0,s.xI)(o),{app:o,auth:i}}catch(e){console.error("\uD83D\uDD25 Error inicializando Firebase:",e)}}},60668:(e,r,t)=>{t.r(r),t.d(r,{cleanupAnonymousUsers:()=>w,closeDay:()=>g,deleteUser:()=>b,deleteViatico:()=>E,ensureMyOneDriveFolder:()=>m,getAllUsers:()=>p,getAllViaticos:()=>l,getCurrentUser:()=>d,getMisViaticos:()=>u,getMyUser:()=>h,setUserRole:()=>f,setUserStatus:()=>y,subscribeToNotifications:()=>S,updateViatico:()=>v,uploadViatico:()=>c});var a=t(50007),s=t(27608);let o="https://viaticos.davidzapata-dz051099.workers.dev";async function i(){await (0,a.h)();let{auth:e}=await Promise.resolve().then(t.bind(t,50007));if(!e)throw Error("Firebase Auth no est\xe1 disponible. Verifica las variables de entorno NEXT_PUBLIC_FIREBASE_API_KEY, FIREBASE_AUTH_DOMAIN y FIREBASE_PROJECT_ID");let r=e.currentUser;if(!r)throw Error("Usuario no autenticado");return await r.getIdToken()}async function n(e,r={}){try{let t,a=await i();for(let i=0;i<3;i++)try{let t=await fetch(`${o}${e}`,{...r,headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`,...r.headers}}),i=await t.json();if(!t.ok){if(!0===i.success)return i;if(401===t.status)throw window.location.href="/login",Error("Sesi\xf3n expirada. Por favor, inicia sesi\xf3n nuevamente.");throw Error(i.message||i.error||"Error en la solicitud")}if(!1===i.success&&i.error)throw Error(i.error||i.message||"Error en la solicitud");let n=r.method?.toUpperCase();return("POST"===n||"PUT"===n||"DELETE"===n)&&(0,s.oR)({title:"\xc9xito",description:"Datos actualizados correctamente.",variant:"success"}),i}catch(r){if(console.warn(`Intento ${i+1} fallido para ${e}:`,r),t=r,2===i)break;await new Promise(e=>setTimeout(e,500*(i+1)))}throw console.error("Network error in apiRequest after 3 attempts:",t,"URL:",`${o}${e}`),Error(`Error de conexi\xf3n: ${t.message||"No se pudo conectar con el servidor"}`)}catch(e){if(e instanceof Error&&(e.message.includes("Usuario no autenticado")||e.message.includes("Sesi\xf3n expirada")))throw window.location.href="/login",Error("Sesi\xf3n expirada. Por favor, inicia sesi\xf3n nuevamente.");throw e}}async function c(e){let r=await i(),t=await fetch(`${o}/api/viaticos`,{method:"POST",headers:{Authorization:`Bearer ${r}`},body:e});if(!t.ok)throw Error((await t.json().catch(()=>({message:"Error al subir vi\xe1tico"}))).message||"Error al subir vi\xe1tico");return(0,s.oR)({title:"\xc9xito",description:"Vi\xe1tico subido correctamente.",variant:"success"}),t.json()}async function u(){return n("/api/viaticos/mis-viaticos")}async function l(){return n("/api/viaticos/all")}async function d(){return n("/api/users/me",{method:"GET"})}async function h(){try{let e=await n("/api/users/me",{method:"GET"});if(e.success&&e.user)return e.user;return null}catch(e){return console.error("Error fetching my user:",e),null}}async function p(){return n("/api/users",{method:"GET"})}async function f(e,r){return n(`/api/users/${e}/role`,{method:"PUT",body:JSON.stringify({role:r})})}async function m(){let e=await i(),r=await fetch(`${o}/api/onedrive/ensure-me`,{method:"POST",headers:{Authorization:`Bearer ${e}`}});if(!r.ok)throw Error((await r.json().catch(()=>({message:"Error asegurando carpeta"}))).message||"Error asegurando carpeta");return r.json()}async function w(){let e=await i(),r=await fetch(`${o}/api/cleanup/anonymous`,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!r.ok)throw Error((await r.json().catch(()=>({message:"Error ejecutando limpieza"}))).message||"Error ejecutando limpieza");return(0,s.oR)({title:"\xc9xito",description:"Limpieza de usuarios an\xf3nimos ejecutada correctamente.",variant:"success"}),r.json()}async function y(e,r){return n(`/api/users/${e}/status`,{method:"PUT",body:JSON.stringify({estado:r})})}async function g(e){return n("/api/users/close-day",{method:"POST",body:JSON.stringify({date:e})})}async function b(e){let r=await i(),t=await fetch(`${o}/api/users/${e}`,{method:"DELETE",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}});if(!t.ok)throw Error((await t.json().catch(()=>({message:"Error eliminando usuario"}))).message||"Error eliminando usuario");return(0,s.oR)({title:"\xc9xito",description:"Usuario eliminado correctamente.",variant:"success"}),t.json()}async function v(e,r){return n(`/api/viaticos/${e}`,{method:"PUT",body:JSON.stringify(r)})}async function E(e){return n(`/api/viaticos/${e}`,{method:"DELETE"})}async function S(e){let r=await i();return fetch(`${o}/api/notifications/subscribe`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify(e)})}},66877:(e,r,t)=>{async function a(){if(!("serviceWorker"in navigator)||!("PushManager"in window))throw Error("Push notifications not supported");let e=await navigator.serviceWorker.ready,r=await fetch("/api/push/vapid-public-key"),{publicKey:t}=await r.json(),a=function(e){let r="=".repeat((4-e.length%4)%4),t=(e+r).replace(/\-/g,"+").replace(/_/g,"/"),a=window.atob(t),s=new Uint8Array(a.length);for(let e=0;e<a.length;++e)s[e]=a.charCodeAt(e);return s}(t),s=await e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:a});return await fetch("/api/push/subscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}),s}async function s(){if(!("serviceWorker"in navigator)||!("PushManager"in window))return;let e=await navigator.serviceWorker.ready,r=await e.pushManager.getSubscription();r&&await fetch("/api/push/unsubscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({endpoint:r.endpoint})}).catch(e=>console.error("Error unsubscribing from backend:",e))}t.d(r,{Q:()=>s,subscribeToPush:()=>a})}}]);